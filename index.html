<html>
<head>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <style>
    .std-1 { width: 150px; height: 150px; padding: 0.5em; }
    .page { background-image: url('grid100.png'); height: 1200px; width: 1200px; }
    body { height: 100%; width: 100%; }
    .ui-tabs { height: 100%; width: 100%; overflow: scroll; }
    .ui-tabs .ui-tabs-panel { overflow: scroll; }
    .sheet { width: 2000px; height: 2000px; background-image: url('grid100.png'); }
    .sheet { position: relative; }
    .ctrl { position: absolute; }
    .ctrl input { margin: 4px; }
    .ctrl input { font-size: 12px; }
    </style>
    <script>
    var GK
    $(function() {
        GK = (function () {
          var gk = function (cmd) {
            var self = this
            return GK.cmds[cmd[0]].apply(GK, cmd);
          }
          gk.ctrlPersistentStyles = ["left", "top", "width", "height"]
          gk.preset = {
            nextCreationPosition: {
              left: 100,
              top: 100
            },
            creationPositionIncrements: {
              left: 10,
              top: 10
            },
            ctrls: {
              ctrl: {
                width: 100,
                height: 100
              }
            }
          }
          gk.utils = {}
          gk.utils.uiPosition = function (position) {
            return "left+" + position.left + " top+" + position.top;
          }
          gk.utils.positionInSheet = function (position) {
            var sheetOffset = gk.sheet().elm.offset()
            return { top: position.top - sheetOffset.top, left: position.left - sheetOffset.left };
          }
          gk.utils.elmPosInSheet = function (elm) {
            return gk.utils.positionInSheet($(elm).position());
          }
          gk.utils.applyAllElmPosToCtrl = function () {
            $(".ctrl").each(function () {
              var elm = this
              $.each(gk.ctrlPersistentStyles, function (index, name) {
                gk.allSpec[elm.id][name] = $(elm).css(name)
              })
            })
          }
          gk.init = function () {

            gk.elm = { room: { elm: $("<div class='room'></div>").uniqueId().appendTo("body") } }
            gk.room = function () {
              return gk.elm.room;
            }
            gk.allElm = {}
            var roomId = gk.elm.room.elm.attr("id")
            gk.allElm[roomId] = gk.elm.room
            gk.spec = {
              preference: $.extend(true, {}, gk.preset),
              room: {
                specOf: "room",
                id: roomId,
                selected: null,
                desks: {}
              }
            }
            gk.allSpec = {}
            gk.allSpec[roomId] = gk.spec.room

            gk.elm.room.desks = {}
            gk(["addDesk", gk.spec.room])
            gk.deskSpec = function () {
              return gk.spec.room.desks[gk.spec.room.selected];
            }
            gk.desk = function () {
              return gk.allElm[gk.deskSpec().id]
            }
            gk.elm.room.desk.books = {}
            gk(["addBook", gk.deskSpec()])
            gk.bookSpec = function () {
              var deskSpec = gk.deskSpec()
              return deskSpec.books[deskSpec.selected];
            }
            gk.book = function () {
              return gk.allElm[gk.bookSpec().id]
            }
            gk(["addSheet", gk.bookSpec()])
            gk.sheetSpec = function () {
              var bookSpec = gk.bookSpec()
              return bookSpec.sheets[bookSpec.selected];
            }
            gk.sheet = function () {
              return gk.allElm[gk.sheetSpec().id]
            }
          }
          gk.cmds = {}
          gk.cmds.addDesk = function (cmd, roomSpec) {
            var room = gk.allElm[roomSpec.id]
            var desk = $("<div class='desk'></div>").uniqueId().appendTo(room.elm)
            var deskId = desk.attr("id")
            room.desk = { elm: desk }
            room.desks[deskId] = room.desk
            var deskSpec = {
              specOf: "desk",
              id: deskId,
              parentId: roomSpec.id,
              selected: null,
              books: {}
            }
            gk.allElm[deskId] = room.desk
            roomSpec.selected = deskId
            roomSpec.desks[deskId] = deskSpec
            gk.allSpec[deskId] = deskSpec
          }
          gk.cmds.removeDesk = function (cmd, deskId) {
            deskId = deskId || (gk.desk().elm.get(0).id)
            var roomId = gk.allSpec[deskId].parentId
            if(roomId) {
              gk(["removeAllBookInDesk", deskId])
              $("#" + deskId).remove()
              delete gk.allSpec[roomId].desks[deskId]
              delete gk.allSpec[deskId]
            }
          }
          gk.cmds.addBook = function (cmd, deskSpec, bookSpec) {
            var desk = gk.allElm[deskSpec.id]
            var book = $("<div class='book'><ul></ul></div>").uniqueId().appendTo(desk.elm)
            book.tabs({
              activate: function (e, ui) {
                gk.bookSpec().selected = $("#" + ui.newPanel.get(0).id).find(".sheet").get(0).id
              }
            })
            var bookId = book.attr("id")
            desk.book = { elm: book, tabTitles: book.find("ul"), sheets: {} }
            desk.books[bookId] = desk.book
            gk.allElm[bookId] = desk.book
            var bookSpec = {
              specOf: "book",
              id: bookId,
              parentId: deskSpec.id,
              preference: $.extend(true, {}, gk.spec.preference),
              selected: null,
              sheets: (bookSpec && bookSpec.sheets) || {}
            }
            deskSpec.selected = bookId
            deskSpec.books[bookId] = bookSpec
            gk.allSpec[bookId] = bookSpec
            $.each(bookSpec.sheets, function (id, sheetSpec) {
              gk(["addSheet", bookSpec, sheetSpec])
            })
          }
          gk.cmds.removeAllBookInDesk = function (cmd, deskId) {
            deskId = deskId || (gk.desk().elm.get(0).id)
            var deskSpec = gk.allSpec[deskId]
            $.each(deskSpec.books, function (bookId) {
              gk(["removeBook", bookId])
            })
            deskSpec.selected = null
          }
          gk.cmds.removeBook = function (cmd, bookId) {
            bookId = bookId || (gk.book().elm.get(0).id)
            var deskId = gk.allSpec[bookId].parentId
            if(deskId) {
              gk(["removeAllSheetInBook", bookId])
              $("#" + bookId).remove()
              delete gk.allSpec[deskId].books[bookId]
              delete gk.allSpec[bookId]
            }
          }
          gk.cmds.addSheet = function (cmd, bookSpec, sheetSpec) {
            var book = gk.allElm[bookSpec.id]
            var tabContent = $("<div class='tab-content'></div>").uniqueId().appendTo(book.elm)
            var tabTitle = $("<li><a href='#" + tabContent.attr("id") + "'></a></li>").uniqueId().appendTo(book.tabTitles)
            var sheet = $("<div class='sheet'></div>").uniqueId().appendTo(tabContent)
            var sheetId = sheet.attr("id")
            $("#" + tabTitle.get(0).id).find("a").text(sheetId)
            book.sheet = { elm: sheet, selected: null, ctrls: {} }
            book.sheets[sheetId] = book.sheet
            gk.allElm[sheetId] = book.sheet
            book.elm.tabs("refresh")
            book.elm.tabs({active: $("#" + bookSpec.id).find("li").length - 1})
            sheetSpec = {
              specOf: "sheet",
              id: sheetId,
              parentId: bookSpec.id,
              tabTitleId: tabTitle.get(0).id,
              tabContentId: tabContent.get(0).id,
              nextCreationPosition: (sheetSpec && sheetSpec.nextCreationPosition) || $.extend(true, {}, bookSpec.preference.nextCreationPosition),
              selected: null,
              ctrls: (sheetSpec && sheetSpec.ctrls) || {}
            }
            bookSpec.selected = sheetId
            bookSpec.sheets[sheetId] = sheetSpec
            gk.allSpec[sheetId] = sheetSpec
            $.each(sheetSpec.ctrls, function (id, ctrlSpec) {
              gk(["addCtrl", sheetSpec, ctrlSpec])
            })
            return sheetId;
          }
          gk.cmds.removeAllSheetInBook = function (cmd, bookId) {
            bookId = bookId || (gk.book().elm.get(0).id)
            var bookSpec = gk.allSpec[bookId]
            $.each(bookSpec.sheets, function (sheetId) {
              gk(["removeSheet", sheetId])
            })
            bookSpec.selected = null
          }
          gk.cmds.removeSheet = function (cmd, sheetId) {
            sheetId = sheetId || (gk.sheet().elm.get(0).id)
            var bookId = gk.allSpec[sheetId].parentId
            if(bookId) {
              gk(["removeAllCtrlInSheet", sheetId])
              var sheetSpec = gk.allSpec[sheetId]
              $("#" + sheetSpec.tabTitleId).remove()
              $("#" + sheetSpec.tabContentId).remove()
              var book = gk.book()
              book.elm.tabs("refresh")
              delete gk.allSpec[bookId].sheets[sheetId]
              delete gk.allSpec[sheetId]
            }
          }
          gk.cmds.findParentId = function (cmd, id) {
            var parentId = null
            $.each(gk.allSpec, function (idInAll, spec) {
              if(
                spec.specOf === "sheet" && (id in spec.ctrls)
                || spec.specOf === "book" && (id in spec.sheets)
                || spec.specOf === "desk" && (id in spec.books)
                || spec.specOf === "room" && (id in spec.desks)
              ) {
                parentId = idInAll
                return false;
              }
            })
            return parentId;
          }
          gk.cmds.addCtrl = function (cmd, sheetSpec, ctrlSpec) {
            var preference = gk.bookSpec().preference
            var sheet = gk.allElm[sheetSpec.id]
            var nextCreationPosition = sheetSpec.nextCreationPosition
            ctrlSpec = ctrlSpec || {}
            ctrlSpec.specOf = ctrlSpec.specOf || "ctrl"
            ctrlSpec.id = null
            ctrlSpec.parentId = sheetSpec.id
            ctrlSpec.width = ctrlSpec.width || preference.ctrls.ctrl.width
            ctrlSpec.height = ctrlSpec.height || preference.ctrls.ctrl.height
            if(ctrlSpec.left === undefined || ctrlSpec.top === undefined) {
              ctrlSpec.left = nextCreationPosition.left
              ctrlSpec.top = nextCreationPosition.top
              nextCreationPosition.left += gk.spec.preference.creationPositionIncrements.left
              nextCreationPosition.top += gk.spec.preference.creationPositionIncrements.top
            }
            var $ctrl = $("<div class='ctrl ui-widget-content'></div>")
            .appendTo(sheet.elm)
            .css("left", ctrlSpec.left).css("top", ctrlSpec.top)
            .width(ctrlSpec.width).height(ctrlSpec.height)
            .uniqueId()
            .on("click", function (e) {
              console.log(this.id);
            })
            var ctrlId = $ctrl.get(0).id
            sheet.ctrl = { elm: $ctrl }
            sheet.ctrls[ctrlId] = sheet.ctrl
            gk.allElm[ctrlId] = sheet.ctrl
            ctrlSpec.id = ctrlId
            sheetSpec.selected = ctrlId
            sheetSpec.ctrls[ctrlId] = ctrlSpec
            gk.allSpec[ctrlId] = ctrlSpec
            if(ctrlSpec.input) {
              var $input = $ctrl.html("<input type='" + ctrlSpec.input.type + "'></input>").find("input")
              $input.width($ctrl.width() - ($input.outerWidth(true) - $input.width()))
              $ctrl.height($input.outerHeight(true))
              $input.val(ctrlId)
            }
            // The ui.resizable have to be applied after elements creation.
            // It won't work unless to do so.
            $ctrl
            .resizable()
            .draggable({grid:[10,10]})
            return ctrlId;
          }
          gk.cmds.removeAllCtrlInSheet = function (cmd, sheetId) {
            sheetId = sheetId || (gk.sheet().elm.get(0).id)
            var sheetSpec = gk.allSpec[sheetId]
            $.each(sheetSpec.ctrls, function (ctrlId) {
              gk(["removeCtrl", ctrlId])
            })
            sheetSpec.selected = null
          }
          gk.cmds.removeCtrl = function (cmd, ctrlId) {
            var sheetId = gk.allSpec[ctrlId].parentId
            if(sheetId) {
              delete gk.allSpec[sheetId].ctrls[ctrlId]
              delete gk.allSpec[ctrlId]
              $("#" + ctrlId).remove()
              console.debug("Removed #" + ctrlId + " in sheet #" + sheetId)
            }
          }
          gk.cmds.download = function (e) {
            gk.utils.applyAllElmPosToCtrl()
            var d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(GK.bookSpec()))
            var a = document.createElement('a')
            a.setAttribute("href", d)
            a.setAttribute("download", "book.json")
            a.click()
          }
          return gk;
        })()
        GK.init()
        console.log(GK.spec);
        $("#testFlightButton").click(function () {
          var arg1 = $("#testText").val()
          GK(["removeDesk", arg1])
          // GK(["removeAllBookInDesk", arg1])
          // GK(["removeBook", arg1])
          // GK(["removeAllSheetInBook", arg1])
          // GK(["findSheetHavingCtrl"])
          // GK(["removeSheet"], arg1)
          // GK(["removeAllCtrlInSheet"], arg1)
          // GK(["removeCtrl", arg1])
          // var res = GK(["findParentId", $("#testText").val()])
          // console.log("# res");
          // console.log(res);
        })
        $("#addInputText").click(function () {
          GK(["addCtrl", GK.sheetSpec(), {input: {type: "text"}}])
        })
        $("#addBook").click(function () {
          GK(["addBook", GK.deskSpec()])
        })
        $("#removeBook").click(function () {
          GK(["removeBook", GK.bookSpec().id])
        })
        $("#addSheet").click(function () {
          GK(["addSheet", GK.bookSpec()])
        })
        $("#removeSheet").click(function () {
          GK(["removeSheet", GK.sheetSpec().id])
        })
        $("#addCtrl").click(function () {
          GK(["addCtrl", GK.sheetSpec()])
        })
        $("#download").click(function (e) {
          GK(["download"])
        })
        function handleFileSelect(evt) {
          var files = evt.target.files;
          if(files.length < 1) { return; }
          var reader = new FileReader();
          reader.onload = function (e) {
            var bookSpec
            try {
              bookSpec = JSON.parse(reader.result)
              console.debug(bookSpec);
            } catch (e) {
              console.error(e);
            }
            GK(["removeBook", GK.bookSpec().id])
            GK(["addBook", GK.deskSpec(), bookSpec])
          }
          reader.readAsText(files[0]);
        }
        document.getElementById('files').addEventListener('change', handleFileSelect, false);
    });
    </script>
</head>
<body>
  <button id="addInputText">Add input text</button>
  <!-- <button id="addBook">Add book</button>
  <button id="removeBook">Remove book</button> -->
  <button id="addSheet">Add sheet</button>
  <button id="removeSheet">Remove sheet</button>
  <!-- <button id="addCtrl">Add ctrl</button> -->
  <button id="download">Download</button>
  <input id="files" type="file" name="files[]" />
  <input id="testText" type="text" />
  <button id="testFlightButton">Test Flight</button>
</body>
</html>
