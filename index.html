<html>
<head>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <style>
    .std-1 { width: 150px; height: 150px; padding: 0.5em; }
    .page { background-image: url('grid120.png'); height: 1200px; width: 1200px; }
    </style>
    <script>
    var GK
    $(function() {
        GK = (function () {
          var gk = function (cmd) {
            var self = this
            gk.cmds[cmd[0]].apply(self, cmd)
          }
          gk.preset = {
            nextCreationPosition: {
              top: 120,
              left: 240
            },
            creationPositionIncrements: {
              top: 10,
              left: 10
            },
            controls: {
              panel: {
                width: 120,
                height: 120
              }
            }
          }
          gk.ctx = {}
          var ctx = gk.ctx
          ctx.controls = {}
          ctx.elms = {}
          ctx.ctrls = {}
          ctx.$page = $(".page")
          gk.utils = {}
          gk.utils.creationPosition = function () {
            var p = $.extend({}, this)
            // this: { left: (int), top: (int) }
            this.top += ctx.default.creationPositionIncrements.top
            this.left += ctx.default.creationPositionIncrements.left
            return p;
          }
          gk.utils.uiPosition = function (position) {
            return "left+" + position.left + " top+" + position.top;
          }
          gk.utils.positionInPage = function (position) {
            var pageOffset = ctx.$page.offset()
            return { top: position.top - pageOffset.top, left: position.left - pageOffset.left };
          }
          gk.utils.elmPosInPage = function (elm) {
            return gk.utils.positionInPage($(elm).position());
          }
          gk.utils.applyAllElmPosToCtrl = function () {
            var self = this
            $.each(gk.ctx.elms, function (id, elm) {
              gk.ctx.ctrls[id].position = self.elmPosInPage(elm)
            })
          }
          gk.cmds = {}
          gk.cmds.clearPage = function () {
            $(".gk-ctrl").remove()
            ctx.elms = {}
            ctx.ctrls = {}
          }
          gk.cmds.createPanel = function (c, control) {
            control = control || $.extend(true, {}, ctx.default.controls["panel"])
            control.position = control.position || gk.utils.creationPosition.apply(ctx.nextCreationPosition)
            console.log(control);
            var elm = $("<div class='ui-widget-content gk-ctrl draggable resizable'>sss</div>")
            .appendTo(ctx.$page)
            .draggable()
            .position({ my: "left top", at: GK.utils.uiPosition(control.position), of: ctx.$page})
            .uniqueId()
            .height(control.height).width(control.width)
            var id = elm.attr("id")
            console.log(id);
            ctx.elms[id] = elm
            ctx.ctrls[id] = control
          }
          return gk;
        })()
        var ctx = GK.ctx
        ctx.default = $.extend(true, {}, GK.preset)
        ctx.nextCreationPosition = $.extend({}, ctx.default.nextCreationPosition)

        $( ".draggable" ).draggable();
        $( ".resizable" ).resizable();
        $( "#text" ).draggable();

        $("#pannelButton").click(function (e) {
          GK(["createPanel"])
        })
        $("#testFlightButton").click(function (e) {
          $.each(ctx.elms, function (id, elm) {
            console.log(id);
            console.log(GK.utils.elmPosInPage(elm));
          })
        })
        $("#clearPageButton").click(function (e) {
          GK(["clearPage"])
        })
        $("#saveButton").click(function (e) {
          GK.utils.applyAllElmPosToCtrl()
          var d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(GK.ctx.ctrls))
          var a = document.createElement('a')
          a.setAttribute("href", d)
          a.setAttribute("download", "data.json")
          a.click()
        })
        function handleFileSelect(evt) {
          var files = evt.target.files; // FileList object
          console.log(files);
          if(files.length < 1) { return; }

          var reader = new FileReader();
          reader.onload = function (e) {
            console.log(reader.result);
            try {
              var ctrls = JSON.parse(reader.result)
              console.log(ctrls);
              $.each(ctrls, function (id, ctrl) {
                // console.log(id, ctrl);
                GK(["createPanel", ctrl])
              })
            } catch (e) {
              console.error(e);
            }
          }
          reader.readAsText(files[0]);
        }

        document.getElementById('files').addEventListener('change', handleFileSelect, false);
    });
    </script>
</head>
<body style="">
  <div class="page">
    <div class="ui-widget-content std-1 draggable resizable">
        <button>Input Text</button>
        <button id="pannelButton">Pannel</button>
        <button id="headerButton">Header</button>
        <button>Footer</button>
        <button>Left Sidebar</button>
        <button>Right Sidebar</button>
        <button id="testFlightButton">Test Flight</button>
        <button id="clearPageButton">Clear Page</button>
        <button id="saveButton">Save</button>
        <input type="file" id="files" name="files[]" />
    </div>
  </div>
</body>
</html>
